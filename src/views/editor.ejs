<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="topbar">
    <div><%= unit.name %></div>
    <nav>
      <a href="/logout">Salir</a>
    </nav>
  </header>
  <div class="container">
    <section class="card">
      <div class="row">
        <label>Mes (YYYY-MM)</label>
        <form method="get" action="/editor" class="row">
          <input type="month" name="month" value="<%= ym %>" id="monthPickerEditor">
          <button type="button" class="button" onclick="(function(){var i=document.getElementById('monthPickerEditor'); if(i && i.showPicker){i.showPicker()} else { i.focus(); i.click(); }})()">ðŸ“…</button>
          <button type="submit">Ver</button>
        </form>
      </div>
      <h2>Registro mensual <%= ym %></h2>
      <% if (unit.id === 4000) { %>
        <form id="ruralForm" method="post" action="/editor/save">
          <input type="hidden" name="month" value="<%= ym %>">
          <table class="grid">
            <thead>
              <tr>
                <th class="col-unidad">Unidad</th>
                <th class="col-tipo">Tipo</th>
                <% days.forEach(function(d){ %>
                  <th><%= d.label %></th>
                <% }) %>
                <th class="col-total">TOTAL</th>
              </tr>
            </thead>
            <tbody>
              <% let gi = 0; %>
              <% (units[areaId] || []).forEach(function(u){ %>
                <% if (u.id === 4000) { return; } %>
                <% const evenOdd = (gi++ % 2 === 0) ? 'even' : 'odd'; %>
                <tr class="group <%= evenOdd %>">
                  <td class="unit col-unidad strong" rowspan="2"><%= u.name %></td>
                  <td class="col-tipo">BOLETAS MANUALES</td>
                  <% var rowSumM = 0; %>
                  <% days.forEach(function(d){ const key = `${u.id}|${d.iso}`; const c = counts[key] || { manual: 0, electronic: 0 }; %>
                    <td>
                      <input type="number" min="0" name="manual[<%= u.id %>][<%= d.iso %>]" value="<%= c.manual %>" <%= (locks && locks[d.iso]) ? 'disabled' : '' %> >
                      <% rowSumM += (c.manual||0); %>
                    </td>
                  <% }) %>
                  <td class="num col-total"><%= rowSumM %></td>
                </tr>
                <tr class="group <%= evenOdd %>">
                  <td class="col-tipo">BOLETAS ELECTRÃ“NICAS</td>
                  <% var rowSumE = 0; %>
                  <% days.forEach(function(d){ const key = `${u.id}|${d.iso}`; const c = counts[key] || { manual: 0, electronic: 0 }; %>
                    <td>
                      <input type="number" min="0" name="electronic[<%= u.id %>][<%= d.iso %>]" value="<%= c.electronic %>" <%= (locks && locks[d.iso]) ? 'disabled' : '' %> >
                      <% rowSumE += (c.electronic||0); %>
                    </td>
                  <% }) %>
                  <td class="num col-total"><%= rowSumE %></td>
                </tr>
              <% }) %>
            </tbody>
            <tfoot>
              <tr>
                <td class="strong" colspan="2">TOTAL</td>
                <% days.forEach(function(d){ var sum = 0; (units[areaId]||[]).forEach(function(u){ if (u.id === 4000) return; var key = `${u.id}|${d.iso}`; var c = counts[key] || { manual: 0, electronic: 0 }; sum += (c.manual||0) + (c.electronic||0); }); %>
                  <td class="num"><%= sum %></td>
                <% }) %>
                <% var grandTotal = 0; days.forEach(function(d){ var sum = 0; (units[areaId]||[]).forEach(function(u){ if (u.id === 4000) return; var key = `${u.id}|${d.iso}`; var c = counts[key] || { manual: 0, electronic: 0 }; sum += (c.manual||0) + (c.electronic||0); }); grandTotal += sum; }); %>
                <td class="num col-total strong"><%= grandTotal %></td>
              </tr>
            </tfoot>
          </table>
          <div class="actions">
            <button type="submit">Guardar</button>
          </div>
        </form>
        <script>
        (function(){
          var form = document.getElementById('ruralForm');
          if(!form) return;
          form.addEventListener('submit', function(ev){
            ev.preventDefault();
            var ym = form.querySelector('input[name="month"]').value;
            var manual = {}, electronic = {};
            var mInputs = form.querySelectorAll('input[name^="manual["]');
            var eInputs = form.querySelectorAll('input[name^="electronic["]');
            mInputs.forEach(function(inp){
              if(inp.disabled) return;
              var v = inp.value;
              if(v === '' || v == null) return;
              var n = parseInt(v, 10); if(isNaN(n)) n = 0;
              var mt = inp.name.match(/^manual\[(\d+)\]\[(\d{4}-\d{2}-\d{2})\]$/);
              if(mt){ var uid = mt[1], date = mt[2]; manual[uid] = manual[uid] || {}; manual[uid][date] = n; }
            });
            eInputs.forEach(function(inp){
              if(inp.disabled) return;
              var v = inp.value;
              if(v === '' || v == null) return;
              var n = parseInt(v, 10); if(isNaN(n)) n = 0;
              var mt = inp.name.match(/^electronic\[(\d+)\]\[(\d{4}-\d{2}-\d{2})\]$/);
              if(mt){ var uid = mt[1], date = mt[2]; electronic[uid] = electronic[uid] || {}; electronic[uid][date] = n; }
            });
            fetch('/editor/save', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin',
              body: JSON.stringify({ month: ym, manual: manual, electronic: electronic })
            }).then(function(r){
              var ct = (r.headers.get('content-type')||'');
              if(ct.indexOf('application/json')!==-1){ return r.json(); }
              window.location.href = '/login';
            }).then(function(){ window.location.href = '/editor?month='+ym; })
              .catch(function(err){ alert('Error al guardar: '+err); });
          });
        })();
        </script>
      <% } else { %>
        <form id="unitForm" method="post" action="/editor/save">
          <input type="hidden" name="month" value="<%= ym %>">
          <table class="grid">
            <thead>
              <tr>
                <th class="col-unidad">Unidad</th>
                <th class="col-tipo">Tipo</th>
                <% days.forEach(function(d){ %>
                  <th><%= d.label %></th>
                <% }) %>
                <th class="col-total">TOTAL</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="unit col-unidad strong" rowspan="2"><%= unit.name %></td>
                <td class="col-tipo">BOLETAS MANUALES</td>
                <% var rowSumM = 0; %>
                <% days.forEach(function(d){ %>
                  <td>
                    <input type="number" min="0" name="manual[<%= d.iso %>]" value="<%= (counts[d.iso] && counts[d.iso].manual) || 0 %>" <%= (locks && locks[d.iso]) ? 'disabled' : '' %> >
                    <% rowSumM += ((counts[d.iso] && counts[d.iso].manual) || 0); %>
                  </td>
                <% }) %>
                <td class="num col-total"><%= rowSumM %></td>
              </tr>
              <tr>
                <td class="col-tipo">BOLETAS ELECTRÃ“NICAS</td>
                <% var rowSumE = 0; %>
                <% days.forEach(function(d){ %>
                  <td>
                    <input type="number" min="0" name="electronic[<%= d.iso %>]" value="<%= (counts[d.iso] && counts[d.iso].electronic) || 0 %>" <%= (locks && locks[d.iso]) ? 'disabled' : '' %> >
                    <% rowSumE += ((counts[d.iso] && counts[d.iso].electronic) || 0); %>
                  </td>
                <% }) %>
                <td class="num col-total"><%= rowSumE %></td>
              </tr>
            </tbody>
          </table>
          <div class="actions">
            <button type="submit">Guardar</button>
          </div>
        </form>
        <script>
        (function(){
          var form = document.getElementById('unitForm');
          if(!form) return;
          form.addEventListener('submit', function(ev){
            ev.preventDefault();
            var ym = form.querySelector('input[name="month"]').value;
            var manual = {}, electronic = {};
            var mInputs = form.querySelectorAll('input[name^="manual["]');
            var eInputs = form.querySelectorAll('input[name^="electronic["]');
            mInputs.forEach(function(inp){
              if(inp.disabled) return;
              var v = inp.value;
              if(v === '' || v == null) return;
              var n = parseInt(v, 10); if(isNaN(n)) n = 0;
              var mt = inp.name.match(/^manual\[(\d{4}-\d{2}-\d{2})\]$/);
              if(mt){ var date = mt[1]; manual[date] = n; }
            });
            eInputs.forEach(function(inp){
              if(inp.disabled) return;
              var v = inp.value;
              if(v === '' || v == null) return;
              var n = parseInt(v, 10); if(isNaN(n)) n = 0;
              var mt = inp.name.match(/^electronic\[(\d{4}-\d{2}-\d{2})\]$/);
              if(mt){ var date = mt[1]; electronic[date] = n; }
            });
            fetch('/editor/save', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin',
              body: JSON.stringify({ month: ym, manual: manual, electronic: electronic })
            }).then(function(r){
              var ct = (r.headers.get('content-type')||'');
              if(ct.indexOf('application/json')!==-1){ return r.json(); }
              window.location.href = '/login';
            }).then(function(){ window.location.href = '/editor?month='+ym; })
              .catch(function(err){ alert('Error al guardar: '+err); });
          });
        })();
        </script>
      <% } %>
    </section>
  </div>
</body>
</html>